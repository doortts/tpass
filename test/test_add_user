#!/usr/bin/env bash

set -e

# https://robots.thoughtbot.com/shell-script-suggestions-for-speedy-setups
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NO_COLOR='\033[0m'
CLEAR_LINE='\r\033[K'

skynet_password=1234321

function copy_tpass {
    from=$1
    to=$2

    docker exec -i $from bash -c \
           "cd /root && tar -cvf tpass_snapshot.tar tpass"
    rm /tmp/tpass_snapshot.tar 2>/dev/null || true
    docker cp $from:/root/tpass_snapshot.tar /tmp/tpass_snapshot.tar
    docker cp /tmp/tpass_snapshot.tar $to:/root/tpass_snapshot.tar
    docker exec -i $to bash -c \
           "cd /root && tar -xvf /root/tpass_snapshot.tar"
}

function log_info { printf "${GREEN}[INFO] $1${NO_COLOR}\n"; }
function log_success { printf "${BLUE}[TEST/SUCCESS] $1${NO_COLOR}\n"; }
function log_failure { printf "${RED}[TEST/FAILURE] $1${NO_COLOR}\n"; }

function assert {
    expected=$1
    actual=$2

    if [ "$expected" == "$actual" ]; then
        log_success "assert $expected == $actual"
        return 0
    else
        log_failure "assert $expected == $actual"
        exit 1
    fi
}

root="$(dirname "$0")/.."
cd $root

docker kill user_a 2>/dev/null || true
docker kill user_b 2>/dev/null || true

docker build -t user_a_img test/user_a@mail.com
docker build -t user_b_img test/user_b@mail.com
docker run -di --rm --name user_a user_a_img bash
docker run -di --rm --name user_b user_b_img bash

tfile=/tmp/tpass.zip
git archive -o $tfile HEAD

docker cp $tfile user_a:/tmp/tpass.zip
docker exec -i user_a unzip /tmp/tpass.zip -d /root/tpass
docker exec -i user_a ln -s /root/tpass/password_store /root/.password-store

log_info "add user - user_a@mail.com"
docker exec -i user_a /root/tpass/bin/add_user user_a@mail.com

log_info "update at user_a"
docker exec -i user_a /root/tpass/bin/update

log_info "add password - skynet"
docker exec -i user_a bash -c "cd /root/tpass &&\
    printf '$skynet_password\n$skynet_password\n' | pass insert skynet"
docker exec -i user_a bash -c "pass ls"
actual=`docker exec -i user_a bash -c "(gpg-agent --daemon || true) && pass skynet"`
assert $skynet_password $actual

log_info "copy tpass in user_a to user_b"
copy_tpass user_a user_b

docker exec -i user_b ln -s /root/tpass/password_store /root/.password-store

log_info "add user - user_b@mail.com"
docker exec -i user_b /root/tpass/bin/add_user user_b@mail.com

log_info "copy tpass in user_b to user_a"
copy_tpass user_b user_a

log_info "update at user_a"
docker exec -i user_a /root/tpass/bin/update

log_info "copy tpass in user_a to user_b"
copy_tpass user_a user_b

log_info "view password on user_b - skynet"
docker exec -i user_b bash -c "pass ls"
actual=`docker exec -i user_b bash -c "(gpg-agent --daemon || true) && pass skynet"`
assert $skynet_password $actual

log_info "test_add_user - OK"
